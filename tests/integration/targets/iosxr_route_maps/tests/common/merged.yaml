---
- ansible.builtin.debug:
    msg: Start iosxr_route_maps merged integration tests connection={{ ansible_connection}}

- ansible.builtin.include_tasks: _remove_config.yaml

- block:
    - name: Merge route-policy configuration
      cisco.iosxr.iosxr_route_maps:
        state: merged
        config:
          - global:
              apply:
                - route_policy: A_NEW_ROUTE_POLICY
              set:
                community:
                  additive: true
                  community_name: (11011:1001)
                weight: 20000
            name: SIMPLE_GLOBAL_ROUTE_POLICY
          - else:
              global:
                drop: true
            if:
              condition: destination in SIMPLE_CONDITION_ROUTE_POLICY
              pass: true
            name: SIMPLE_CONDITION_ROUTE_POLICY
          - else:
              else:
                drop: true
              if:
                condition: destination in A_RANDOM_POLICY
                pass: true
                set:
                  community:
                    additive: true
                    community_name: (101010:1)
            if:
              condition: as-path in (ios-regex '_3117_', ios-regex '_600_')
              drop: true
            name: COMPLEX_ROUTE_POLICY
          - else:
              global:
                pass: true
            if:
              condition: community matches-any (9119:1001) or community matches-any (11100:1001)
              drop: true
            name: COMPLEX_CONDITION_ROUTE_POLICY
      register: result

    - name: Assert that before dicts were correctly generated
      ansible.builtin.assert:
        that: "{{ result['before'] == {} }}"

    - name: Assert that correct set of commands were generated
      ansible.builtin.assert:
        that:
          - "{{ merged['commands'] | symmetric_difference(result['commands']) |length == 0 }}"

    - name: Assert that after dicts were correctly generated
      ansible.builtin.assert:
        that:
          - merged['after'] == result['after']

  always:
    - ansible.builtin.include_tasks: _remove_config.yaml
